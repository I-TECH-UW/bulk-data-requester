<?xml version="1.0" encoding="UTF-8"?>  
<databaseChangeLog  
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"  
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"  
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

        <changeSet author="rossumg" id="5">
		<preConditions onFail="MARK_RAN">
			<tableExists tableName="datamart.agegroups1"/>
                </preConditions>
                <sql>
			create sequence if not exists datamart.agegroups1_seq start 1 increment 1;

			create table if not exists datamart.agegroups1 (
				id integer,
     				ageGrp varchar(50),
     				startAge integer,
     				endAge integer);

			insert into agegroups1 values 
				(nextval('datamart.agegroups1_seq'), '0to14yrs',0,15),
				(nextval('datamart.agegroups1_seq'), '15to19yrs',15,20),
				(nextval('datamart.agegroups1_seq'), '20to39yrs',20,40),
				(nextval('datamart.agegroups1_seq'), '40to59yrs',40,60),
				(nextval('datamart.agegroups1_seq'), '60to74yrs',60,75),
				(nextval('datamart.agegroups1_seq'), '75andUp','75','110');
                </sql>
        </changeSet>
        
       <changeSet author="rossumg" id="10">
	        <preConditions onFail="MARK_RAN">
                                <tableExists tableName="datamart.cdcwk"/>
                </preConditions>
                <sql>
			create sequence if not exists datamart.cdcwk_seq start 1 increment 1;

			create table if not exists datamart.cdcwk (
				id bigint not null,
     				cdcwk integer,
     				wkStart timestamp,
     				wkEnd timestamp,
     				CONSTRAINT cdcwk_pkey PRIMARY KEY (id));

                	insert into datamart.cdcwk (id, cdcwk, wkStart, wkEnd) values 
                	(nextval('datamart.cdcwk_seq'),1 ,'2019-12-29 00:00:00','2020-01-04 23:59:59'),
			(nextval('datamart.cdcwk_seq'),2 ,'2020-01-05 00:00:00','2020-01-11 23:59:59'),
			(nextval('datamart.cdcwk_seq'),3 ,'2020-01-12 00:00:00','2020-01-18 23:59:59'),
			(nextval('datamart.cdcwk_seq'),4 ,'2020-01-19 00:00:00','2020-01-25 23:59:59'),
			(nextval('datamart.cdcwk_seq'),5 ,'2020-01-26 00:00:00','2020-02-01 23:59:59'),
			(nextval('datamart.cdcwk_seq'),6 ,'2020-02-02 00:00:00','2020-02-08 23:59:59'),
			(nextval('datamart.cdcwk_seq'),7 ,'2020-02-09 00:00:00','2020-02-15 23:59:59'),
			(nextval('datamart.cdcwk_seq'),8 ,'2020-02-16 00:00:00','2020-02-22 23:59:59'),
			(nextval('datamart.cdcwk_seq'),9 ,'2020-02-23 00:00:00','2020-02-29 23:59:59'),
			(nextval('datamart.cdcwk_seq'),10,'2020-03-01 00:00:00','2020-03-07 23:59:59'),
			(nextval('datamart.cdcwk_seq'),11,'2020-03-08 00:00:00','2020-03-14 23:59:59'),
			(nextval('datamart.cdcwk_seq'),12,'2020-03-15 00:00:00','2020-03-21 23:59:59'),
			(nextval('datamart.cdcwk_seq'),13,'2020-03-22 00:00:00','2020-03-28 23:59:59'),
			(nextval('datamart.cdcwk_seq'),14,'2020-03-29 00:00:00','2020-04-04 23:59:59'),
			(nextval('datamart.cdcwk_seq'),15,'2020-04-05 00:00:00','2020-04-11 23:59:59'),
			(nextval('datamart.cdcwk_seq'),16,'2020-04-12 00:00:00','2020-04-18 23:59:59'),
			(nextval('datamart.cdcwk_seq'),17,'2020-04-19 00:00:00','2020-04-25 23:59:59'),
			(nextval('datamart.cdcwk_seq'),18,'2020-04-26 00:00:00','2020-05-02 23:59:59'),
			(nextval('datamart.cdcwk_seq'),19,'2020-05-03 00:00:00','2020-05-09 23:59:59'),
			(nextval('datamart.cdcwk_seq'),20,'2020-05-10 00:00:00','2020-05-16 23:59:59'),
			(nextval('datamart.cdcwk_seq'),21,'2020-05-17 00:00:00','2020-05-23 23:59:59'),
			(nextval('datamart.cdcwk_seq'),22,'2020-05-24 00:00:00','2020-05-30 23:59:59'),
			(nextval('datamart.cdcwk_seq'),23,'2020-05-31 00:00:00','2020-06-06 23:59:59'),
			(nextval('datamart.cdcwk_seq'),24,'2020-06-07 00:00:00','2020-06-13 23:59:59'),
			(nextval('datamart.cdcwk_seq'),25,'2020-06-14 00:00:00','2020-06-20 23:59:59'),
			(nextval('datamart.cdcwk_seq'),26,'2020-06-21 00:00:00','2020-06-27 23:59:59'),
			(nextval('datamart.cdcwk_seq'),27,'2020-06-28 00:00:00','2020-07-04 23:59:59'),
			(nextval('datamart.cdcwk_seq'),28,'2020-07-05 00:00:00','2020-07-11 23:59:59'),
			(nextval('datamart.cdcwk_seq'),29,'2020-07-12 00:00:00','2020-07-18 23:59:59'),
			(nextval('datamart.cdcwk_seq'),30,'2020-07-19 00:00:00','2020-07-25 23:59:59'),
			(nextval('datamart.cdcwk_seq'),31,'2020-07-26 00:00:00','2020-08-01 23:59:59'),
			(nextval('datamart.cdcwk_seq'),32,'2020-08-02 00:00:00','2020-08-08 23:59:59'),
			(nextval('datamart.cdcwk_seq'),33,'2020-08-09 00:00:00','2020-08-15 23:59:59'),
			(nextval('datamart.cdcwk_seq'),34,'2020-08-16 00:00:00','2020-08-22 23:59:59'),
			(nextval('datamart.cdcwk_seq'),35,'2020-08-23 00:00:00','2020-08-29 23:59:59'),
			(nextval('datamart.cdcwk_seq'),36,'2020-08-30 00:00:00','2020-09-05 23:59:59'),
			(nextval('datamart.cdcwk_seq'),37,'2020-09-06 00:00:00','2020-09-12 23:59:59'),
			(nextval('datamart.cdcwk_seq'),38,'2020-09-13 00:00:00','2020-09-19 23:59:59'),
			(nextval('datamart.cdcwk_seq'),39,'2020-09-20 00:00:00','2020-09-26 23:59:59'),
			(nextval('datamart.cdcwk_seq'),40,'2020-09-27 00:00:00','2020-10-03 23:59:59'),
			(nextval('datamart.cdcwk_seq'),41,'2020-10-04 00:00:00','2020-10-10 23:59:59'),
			(nextval('datamart.cdcwk_seq'),42,'2020-10-11 00:00:00','2020-10-17 23:59:59'),
			(nextval('datamart.cdcwk_seq'),43,'2020-10-18 00:00:00','2020-10-24 23:59:59'),
			(nextval('datamart.cdcwk_seq'),44,'2020-10-25 00:00:00','2020-10-31 23:59:59'),
			(nextval('datamart.cdcwk_seq'),45,'2020-11-01 00:00:00','2020-11-07 23:59:59'),
			(nextval('datamart.cdcwk_seq'),46,'2020-11-08 00:00:00','2020-11-14 23:59:59'),
			(nextval('datamart.cdcwk_seq'),47,'2020-11-15 00:00:00','2020-11-21 23:59:59'),
			(nextval('datamart.cdcwk_seq'),48,'2020-11-22 00:00:00','2020-11-28 23:59:59'),
			(nextval('datamart.cdcwk_seq'),49,'2020-11-29 00:00:00','2020-12-05 23:59:59'),
			(nextval('datamart.cdcwk_seq'),50,'2020-12-06 00:00:00','2020-12-12 23:59:59'),
			(nextval('datamart.cdcwk_seq'),51,'2020-12-13 00:00:00','2020-12-19 23:59:59'),
			(nextval('datamart.cdcwk_seq'),52,'2020-12-20 00:00:00','2020-12-26 23:59:59'),
			(nextval('datamart.cdcwk_seq'),53,'2020-12-27 00:00:00','2021-01-02 23:59:59'),
			(nextval('datamart.cdcwk_seq'),1 ,'2021-01-03 00:00:00','2021-01-09 23:59:59'),
			(nextval('datamart.cdcwk_seq'),2 ,'2021-01-10 00:00:00','2021-01-16 23:59:59'),
			(nextval('datamart.cdcwk_seq'),3 ,'2021-01-17 00:00:00','2021-01-23 23:59:59'),
			(nextval('datamart.cdcwk_seq'),4 ,'2021-01-24 00:00:00','2021-01-30 23:59:59'),
			(nextval('datamart.cdcwk_seq'),5 ,'2021-01-31 00:00:00','2021-02-06 23:59:59'),
			(nextval('datamart.cdcwk_seq'),6 ,'2021-02-07 00:00:00','2021-02-13 23:59:59'),
			(nextval('datamart.cdcwk_seq'),7 ,'2021-02-14 00:00:00','2021-02-20 23:59:59'),
			(nextval('datamart.cdcwk_seq'),8 ,'2021-02-21 00:00:00','2021-02-27 23:59:59'),
			(nextval('datamart.cdcwk_seq'),9 ,'2021-02-28 00:00:00','2021-03-06 23:59:59'),
			(nextval('datamart.cdcwk_seq'),10,'2021-03-07 00:00:00','2021-03-13 23:59:59'),
			(nextval('datamart.cdcwk_seq'),11,'2021-03-14 00:00:00','2021-03-20 23:59:59'),
			(nextval('datamart.cdcwk_seq'),12,'2021-03-21 00:00:00','2021-03-27 23:59:59'),
			(nextval('datamart.cdcwk_seq'),13,'2021-03-28 00:00:00','2021-04-03 23:59:59'),
			(nextval('datamart.cdcwk_seq'),14,'2021-04-04 00:00:00','2021-04-10 23:59:59'),
			(nextval('datamart.cdcwk_seq'),15,'2021-04-11 00:00:00','2021-04-17 23:59:59'),
			(nextval('datamart.cdcwk_seq'),16,'2021-04-18 00:00:00','2021-04-24 23:59:59'),
			(nextval('datamart.cdcwk_seq'),17,'2021-04-25 00:00:00','2021-05-01 23:59:59'),
			(nextval('datamart.cdcwk_seq'),18,'2021-05-02 00:00:00','2021-05-08 23:59:59'),
			(nextval('datamart.cdcwk_seq'),19,'2021-05-09 00:00:00','2021-05-15 23:59:59'),
			(nextval('datamart.cdcwk_seq'),20,'2021-05-16 00:00:00','2021-05-22 23:59:59'),
			(nextval('datamart.cdcwk_seq'),21,'2021-05-23 00:00:00','2021-05-29 23:59:59'),
			(nextval('datamart.cdcwk_seq'),22,'2021-05-30 00:00:00','2021-06-05 23:59:59'),
			(nextval('datamart.cdcwk_seq'),23,'2021-06-06 00:00:00','2021-06-12 23:59:59'),
			(nextval('datamart.cdcwk_seq'),24,'2021-06-13 00:00:00','2021-06-19 23:59:59'),
			(nextval('datamart.cdcwk_seq'),25,'2021-06-20 00:00:00','2021-06-26 23:59:59'),
			(nextval('datamart.cdcwk_seq'),26,'2021-06-27 00:00:00','2021-07-03 23:59:59'),
			(nextval('datamart.cdcwk_seq'),27,'2021-07-04 00:00:00','2021-07-10 23:59:59'),
			(nextval('datamart.cdcwk_seq'),28,'2021-07-11 00:00:00','2021-07-17 23:59:59'),
			(nextval('datamart.cdcwk_seq'),29,'2021-07-18 00:00:00','2021-07-24 23:59:59'),
			(nextval('datamart.cdcwk_seq'),30,'2021-07-25 00:00:00','2021-07-31 23:59:59'),
			(nextval('datamart.cdcwk_seq'),31,'2021-08-01 00:00:00','2021-08-07 23:59:59'),
			(nextval('datamart.cdcwk_seq'),32,'2021-08-08 00:00:00','2021-08-14 23:59:59'),
			(nextval('datamart.cdcwk_seq'),33,'2021-08-15 00:00:00','2021-08-21 23:59:59'),
			(nextval('datamart.cdcwk_seq'),34,'2021-08-22 00:00:00','2021-08-28 23:59:59'),
			(nextval('datamart.cdcwk_seq'),35,'2021-08-29 00:00:00','2021-09-04 23:59:59'),
			(nextval('datamart.cdcwk_seq'),36,'2021-09-05 00:00:00','2021-09-11 23:59:59'),
			(nextval('datamart.cdcwk_seq'),37,'2021-09-12 00:00:00','2021-09-18 23:59:59'),
			(nextval('datamart.cdcwk_seq'),38,'2021-09-19 00:00:00','2021-09-25 23:59:59'),
			(nextval('datamart.cdcwk_seq'),39,'2021-09-26 00:00:00','2021-10-02 23:59:59'),
			(nextval('datamart.cdcwk_seq'),40,'2021-10-03 00:00:00','2021-10-09 23:59:59'),
			(nextval('datamart.cdcwk_seq'),41,'2021-10-10 00:00:00','2021-10-16 23:59:59'),
			(nextval('datamart.cdcwk_seq'),42,'2021-10-17 00:00:00','2021-10-23 23:59:59'),
			(nextval('datamart.cdcwk_seq'),43,'2021-10-24 00:00:00','2021-10-30 23:59:59'),
			(nextval('datamart.cdcwk_seq'),44,'2021-10-31 00:00:00','2021-11-06 23:59:59'),
			(nextval('datamart.cdcwk_seq'),45,'2021-11-07 00:00:00','2021-11-13 23:59:59'),
			(nextval('datamart.cdcwk_seq'),46,'2021-11-14 00:00:00','2021-11-20 23:59:59'),
			(nextval('datamart.cdcwk_seq'),47,'2021-11-21 00:00:00','2021-11-27 23:59:59'),
			(nextval('datamart.cdcwk_seq'),48,'2021-11-28 00:00:00','2021-12-04 23:59:59'),
			(nextval('datamart.cdcwk_seq'),49,'2021-12-05 00:00:00','2021-12-11 23:59:59'),
			(nextval('datamart.cdcwk_seq'),50,'2021-12-12 00:00:00','2021-12-18 23:59:59'),
			(nextval('datamart.cdcwk_seq'),51,'2021-12-19 00:00:00','2021-12-25 23:59:59'),
			(nextval('datamart.cdcwk_seq'),52,'2021-12-26 00:00:00','2022-01-01 23:59:59');
                </sql>
	</changeSet>

	<changeSet author="rossumg" id="15">
	        <preConditions onFail="MARK_RAN">
                                <tableExists tableName="datamart.etlrecord"/>
                </preConditions>
                <sql>
CREATE TABLE IF NOT EXISTS clinlims.etlrecord
(
    id bigint NOT NULL,
    created timestamp without time zone,
    created_by character varying(255) COLLATE pg_catalog."default",
    last_modified timestamp without time zone,
    last_modified_by character varying(255) COLLATE pg_catalog."default",
    external_id character varying(255) COLLATE pg_catalog."default",
    patient_id character varying(255) COLLATE pg_catalog."default",
    status_id character varying(255) COLLATE pg_catalog."default",
    address_city character varying(255) COLLATE pg_catalog."default",
    address_country character varying(255) COLLATE pg_catalog."default",
    address_street character varying(255) COLLATE pg_catalog."default",
    age_months integer,
    age_weeks integer,
    age_years integer,
    birthdate timestamp without time zone,
    code_referer character varying(255) COLLATE pg_catalog."default",
    data character varying(1024) COLLATE pg_catalog."default",
    date_collect timestamp without time zone,
    date_entered timestamp without time zone,
    date_recpt timestamp without time zone,
    first_name character varying(255) COLLATE pg_catalog."default",
    home_phone character varying(255) COLLATE pg_catalog."default",
    identifier character varying(255) COLLATE pg_catalog."default",
    labno character varying(255) COLLATE pg_catalog."default",
    last_name character varying(255) COLLATE pg_catalog."default",
    order_timestamp timestamp without time zone,
    order_status character varying(255) COLLATE pg_catalog."default",
    program character varying(255) COLLATE pg_catalog."default",
    referer character varying(255) COLLATE pg_catalog."default",
    result character varying(255) COLLATE pg_catalog."default",
    sex character varying(255) COLLATE pg_catalog."default",
    test character varying(255) COLLATE pg_catalog."default",
    work_phone character varying(255) COLLATE pg_catalog."default",
    CONSTRAINT etlrecord_pkey PRIMARY KEY (id)
);

  create or replace view datamart.etlrecord_view as (
select *,
case
  when test='Antigen Covid' or test='COVID-19 PCR'
    then 'COVID 19'  
  else null
  end condition,
case
  when test in ('Antigen Covid', 'COVID-19 PCR') and result in ('Postive', 'SARS-CoV-2 RNA DETECTED')
    then 'Positive'
  when test in ('Antigen Covid', 'COVID-19 PCR') and result in ('Negative', 'SARS-COV-2 RNA NOT DETECTED')
    then 'Negative' 
  when test in ('Antigen Covid', 'COVID-19 PCR') and result not in ('Negative', 'SARS-COV-2 RNA NOT DETECTED', 'SARS-CoV-2 RNA DETECTED')
    then 'Other Status'
  else null
  end casedef,
case
  when test in ('Antigen Covid', 'COVID-19 PCR') and result in ('Postive', 'SARS-CoV-2 RNA DETECTED')
    then 3
  when test in ('Antigen Covid', 'COVID-19 PCR') and result in ('Negative', 'SARS-COV-2 RNA NOT DETECTED')
    then 2
  when test in ('Antigen Covid', 'COVID-19 PCR') and result not in ('Negative', 'SARS-COV-2 RNA NOT DETECTED')
    then 1
  else null
  end resultcode
from datamart.etlrecord);
                </sql>

</databaseChangeLog>
